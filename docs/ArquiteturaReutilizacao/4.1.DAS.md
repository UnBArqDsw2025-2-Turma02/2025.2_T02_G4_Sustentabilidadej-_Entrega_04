# 4.1. Documento de Arquitetura de Software (DAS)

## Visão Geral

Este documento descreve a arquitetura do sistema **SustentabilidadeJá**, que visa criar uma plataforma para compreender e promover a sustentabilidade. O documento apresenta as visões arquiteturais do sistema, seus componentes principais, padrões de design utilizados e decisões arquiteturais.

## 1. Introdução

### 1.1 Objetivo

O Documento de Arquitetura de Software (DAS) descreve a estrutura geral do sistema SustentabilidadeJá, apresentando as principais visões arquiteturais, componentes, padrões de design e decisões técnicas que guiaram o desenvolvimento do projeto.

### 1.2 Escopo

Este documento cobre:

- Visão Lógica da arquitetura
- Visão de Casos de Uso
- Visão de Implementação
- Padrões de Design utilizados
- Decisões arquiteturais e suas justificativas

### 1.3 Referências

- [IEEE 1471-2000: Recommended Practice for Architectural Description of Software-Intensive Systems](https://standards.ieee.org/)
- [The C4 Model for Visualising Software Architecture](https://c4model.com/)
- [Clean Architecture by Robert C. Martin](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

## 2. Representação Arquitetural

### 2.1 Abordagem

A arquitetura do sistema adota uma abordagem **cliente-servidor** com **frontend web interativo** e **backend Node.js + Express + tRPC** (RPC tipado sobre HTTP), seguindo princípios de arquitetura limpa, separação de responsabilidades e contratos end-to-end fortemente tipados (TypeScript compartilhado).

### 2.2 Componentes Principais

#### Frontend (Cliente)
- **Aplicação Web**: Interface responsiva desenvolvida em React
- **Tecnologias**: React, TypeScript, Tailwind CSS
- **Responsabilidades**: Renderização da interface, interação com o usuário, consumo de APIs

#### Backend (Servidor)
- **API tRPC**: Servidor de aplicação expondo procedimentos tipados
- **Tecnologias**: Node.js, Express, tRPC, Drizzle ORM (MySQL)
- **Responsabilidades**: Lógica de negócio, acesso a dados, autenticação OAuth/JWT, integrações (LLM, armazenamento S3)

#### Armazenamento de Dados
- **Banco de Dados**: Persistência de dados da aplicação
- **Cache**: Otimização de performance
- **Responsabilidades**: Armazenamento e recuperação de dados

## 3. Visão Lógica

### 3.1 Camadas da Aplicação

A arquitetura segue o padrão de **camadas em três níveis**:

```
┌─────────────────────────────────────┐
│      Camada de Apresentação         │
│  (UI Components, Pages, Layouts)    │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│      Camada de Negócio              │
│  (Services, Use Cases, Validators)  │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│      Camada de Dados                │
│  (Repositories, Models, Database)   │
└─────────────────────────────────────┘
```

### 3.2 Módulos Principais

| Módulo | Responsabilidade | Tecnologia |
|--------|------------------|-----------|
| **UI Components / Design System** | Componentes reutilizáveis e estilização consistente | React + Tailwind CSS v4 + Radix UI + CVA |
| **Pages** | Páginas e rotas de alto nível | wouter (roteamento leve) |
| **tRPC Procedures** | Exposição de operações de domínio | tRPC + TypeScript |
| **Data Fetching** | Sincronização de dados e cache reativo | React Query + tRPC client |
| **State Management** | Estado de UI e tema | React Context + Hooks customizados |
| **Database / Data Access** | Persistência e consultas | Drizzle ORM + MySQL (mysql2) |
| **Auth & Security** | Login, OAuth, tokens JWT | jose + módulos internos |
| **AI & Media** | Chat, geração de imagem, voz, armazenamento | OpenAI API + AWS S3 |
| **Shared** | Tipos, constantes, erros | TypeScript + Zod |

## 4. Visão de Casos de Uso

### 4.1 Atores Principais

- **Usuário Visitante**: Acessa a plataforma para consultar informações
- **Usuário Autenticado**: Interage com funcionalidades personalizadas
- **Administrador**: Gerencia conteúdo e usuários da plataforma

### 4.2 Casos de Uso Principais

#### UC1: Consultar Informações de Sustentabilidade
- **Ator**: Usuário Visitante
- **Descrição**: Usuário busca e consulta informações sobre sustentabilidade
- **Fluxo Principal**: 
  1. Usuário acessa a página inicial
  2. Sistema exibe conteúdo sobre sustentabilidade
  3. Usuário navega entre diferentes tópicos

#### UC2: Autenticar Usuário
- **Ator**: Usuário
- **Descrição**: Usuário realiza login na plataforma
- **Fluxo Principal**:
  1. Usuário acessa página de login
  2. Insere credenciais
  3. Sistema valida e autentica
  4. Usuário é redirecionado para dashboard

#### UC3: Gerenciar Conteúdo
- **Ator**: Administrador
- **Descrição**: Administrador adiciona/edita/remove conteúdo
- **Fluxo Principal**:
  1. Admin acessa painel administrativo
  2. Seleciona opção de gerenciamento
  3. Realiza operações CRUD
  4. Sistema persiste alterações

## 5. Padrões de Design

### 5.1 Padrões Utilizados

| Padrão / Prática | Contexto | Benefício |
|------------------|----------|-----------|
| **tRPC Endpoints** | Contratos tipados client ↔ server | Redução de boilerplate e segurança de tipos end-to-end |
| **Data Access Layer (Drizzle)** | Funções concentradas para leitura/escrita | Simplicidade, tipagem forte, fácil evolução do schema |
| **Schema Validation (Zod)** | Validação de dados em fronteiras | Integridade e feedback rápido de erros |
| **Design System com Variants (CVA)** | Componentes estilizados configuráveis | Consistência visual e reutilização |
| **Mock Data Strategy (Dev)** | Fallback quando DB indisponível em dev | Produtividade e isolamento de problemas externos |

### 5.2 Exemplo de Implementação

```typescript
// tRPC procedure com validação Zod e acesso via Drizzle
import { publicProcedure, router } from './_core/trpc';
import { z } from 'zod';
import { getUserByOpenId, upsertUser } from '../server/db';

const userInput = z.object({
  openId: z.string(),
  name: z.string().optional(),
});

export const userRouter = router({
  getByOpenId: publicProcedure
    .input(z.object({ openId: z.string() }))
    .query(async ({ input }) => {
      return await getUserByOpenId(input.openId);
    }),
  upsert: publicProcedure
    .input(userInput)
    .mutation(async ({ input }) => {
      await upsertUser({ openId: input.openId, name: input.name });
      return { success: true };
    }),
});
```

## 6. Visão de Implementação

### 6.1 Estrutura de Diretórios

Estrutura real do repositório (pasta `app/sustentabilidade-ja`):

```
sustentabilidade-ja/
├── client/
│   ├── index.html                # HTML base servido em produção
│   └── src/
│       ├── App.tsx               # Composição principal
│       ├── main.tsx              # Entry do frontend (Vite)
│       ├── const.ts              # Constantes de UI/client
│       ├── index.css             # Estilos (Tailwind v4 + tokens custom)
│       ├── _core/
│       │   └── hooks/useAuth.ts  # Hook de autenticação
│       ├── components/           # Componentes reutilizáveis (UI, layouts, mapas, chat IA)
│       │   └── ui/               # Design System baseado em Radix + Tailwind
│       ├── pages/                # Páginas (Dashboard, Marketplace, Community, etc.)
│       ├── contexts/             # Contextos (tema, etc.)
│       ├── hooks/                # Hooks utilitários (mobile, persistFn, composição)
│       └── lib/                  # Clientes utilitários (tRPC, helpers)
├── server/
│   ├── _core/                    # Núcleo do backend (context, trpc, oauth, llm, image, voice, vite, map, cookies, notification)
│   ├── db.ts                     # Acesso e operações ao banco (Drizzle + mysql2)
│   ├── routers.ts                # Definição das rotas tRPC
│   ├── storage.ts                # Abstração de storage (ex: S3)
│   ├── actions.test.ts           # Testes de ações
│   ├── auth.logout.test.ts       # Teste de fluxo de logout
│   └── types/                    # Tipos específicos do servidor
├── drizzle/
│   ├── schema.ts                 # Definição de tabelas (Drizzle ORM)
│   ├── relations.ts              # Relações entre entidades
│   ├── migrations/               # Migrações geradas
│   └── meta/                     # Metadados de migração
├── shared/                       # Código compartilhado (constantes, tipos, erros)
│   ├── const.ts
│   ├── types.ts
│   └── _core/errors.ts
├── seed-data.*                   # Scripts de seed de dados
├── patches/                      # Patches pnpm (ex: wouter)
├── package.json                  # Dependências e scripts
├── tsconfig.json                 # Configuração TypeScript
├── vite.config.ts                # Build e dev configuration do frontend
├── vitest.config.ts              # Configuração de testes (Vitest)
├── drizzle.config.ts             # Configuração do Drizzle (dialeto MySQL)
└── docs/                         # Documentação (fora da pasta principal do app)
```

Observações:
1. A arquitetura privilegia integração direta entre frontend e backend via tRPC (contratos tipados) em vez de REST tradicional.
2. O roteamento no frontend usa `wouter` (leve) em vez de React Router.
3. O design system combina Radix UI, Tailwind CSS v4 e utilitários como `class-variance-authority`.
4. O banco usa Drizzle ORM com dialeto MySQL (`mysql2`), e scripts de migração automatizados.

### 6.2 Tecnologias

**Frontend:**
- React 19 + TypeScript
- Vite 7 (bundler/dev server)
- Tailwind CSS v4 + plugins (`@tailwindcss/typography`, animações)
- Radix UI (component primitives)
- wouter (roteamento)
- tRPC client + React Query (data fetching reativo tipado)
- Zod (validação e schemas compartilhados)
- Framer Motion / Embla (animações e carrossel)
- OpenAI (integrações de chat/geração de imagem no client quando aplicável)

**Backend:**
- Node.js + Express (servidor HTTP base)
- tRPC Server (camada de API tipada)
- Drizzle ORM (mapeamento relacional) + `mysql2` (dialeto MySQL)
- Autenticação OAuth + JWT (via `jose` e módulos internos)
- AWS SDK S3 (armazenamento de mídia/provas)
- OpenAI API (LLM, geração de imagem, transcrição de voz)
- SuperJSON (serialização avançada de dados entre client/server)
- Vitest (testes automatizados) + tsx (execução TS no dev)
- Dotenv / Config centralizada (`env.ts`)

**Suporte/Utilitários Compartilhados:**
- Zod (tipos e validação de contratos)
- class-variance-authority / tailwind-merge (gestão de variantes de componentes)
- Date-fns (manipulação de datas)
- Lucide-react (ícones)
- Radix UI primitives

Removido do documento anterior: menções a FastAPI, MongoDB e PostgreSQL (não utilizados na implementação atual).

## 7. Decisões Arquiteturais

### 7.1 Decisão 1: Arquitetura Cliente-Servidor + tRPC

**Contexto**: Necessidade de aplicação web escalável e responsiva

**Decisão**: Adotar arquitetura cliente-servidor com separação clara entre frontend e backend e uso de tRPC para comunicação tipada

**Justificativa**: 
- Permite escalabilidade independente
- Facilita manutenção e evolução
- Possibilita reutilização de APIs

**Consequências**:
- Comunicação simplificada (procedures em vez de múltiplos endpoints REST)
- Tipos compartilhados reduzem erros de integração
- Requer cuidados em versionamento de contratos e segurança (auth, validação)

### 7.2 Decisão 2: Uso de React + Design System com Tailwind/Radix

**Contexto**: Desenvolvimento de interface web moderna e interativa

**Decisão**: Utilizar React como framework principal com Tailwind CSS v4, Radix UI e estratégia de variants (CVA) para acelerar construção de UI consistente

**Justificativa**:
- Componentes reutilizáveis
- Comunidade ativa e bem documentada
- Ferramentas de desenvolvimento maduras

**Consequências**:
- Curva de aprendizado moderada (Radix + Tailwind design tokens)
- Necessário alinhamento em convenções de composição e estilos
- Facilita evolução e reuso de componentes complexos

## 8. Qualidade e Não-Funcionais

### 8.1 Atributos de Qualidade

| Atributo | Meta | Estratégia |
|----------|------|-----------|
| **Performance** | Tempo de resposta < 2s | Otimização de queries, uso de React Query cache (caching avançado planejado) |
| **Segurança** | Proteção contra ataques comuns | Validação de entrada, HTTPS |
| **Usabilidade** | Interface intuitiva | Testes com usuários |
| **Manutenibilidade** | Código limpo e bem documentado | Code reviews, testes automatizados |
| **Escalabilidade** | Suportar crescimento de usuários | Arquitetura modular e distribuída |

## 9. Histórico de Versões

| Versão | Data | Autor | Descrição |
|--------|------|-------|-----------|
| 1.1 | 2025-11-21 | Equipe | Alinhamento com implementação (tRPC, Drizzle, wouter, padrões reais) |
| 1.0 | 2025-11-21 | [Davi Emanuel](https://github.com/daviRolvr) e [Gustavo Gontijo Lima](https://github.com/Guga301104) | Versão inicial do DAS |

## 10. Referências e Recursos

- [Clean Code by Robert C. Martin](https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882)
- [Design Patterns by Gang of Four](https://en.wikipedia.org/wiki/Design_Patterns)
- [React Documentation](https://react.dev/)
- [Node.js Best Practices](https://github.com/goldbergyoni/nodebestpractices)

## 11. Próximas Etapas

- [ ] Implementar visão de dados detalhada
- [ ] Adicionar diagramas de sequência
- [ ] Documentar padrões de segurança
- [ ] Criar guia de contribuição
- [ ] Estabelecer métricas de qualidades